/* ---------------------------------------------------------------------
   (c) Emmanuel Delahaye 2005
   Project      : CLIB.ED
   Function     : Allocated strings FIFO
   Module       :
   File         : fifos.c
   Created      : 23-01-2005
   Modified     : 23-01-2005
   --------------------------------------------------------------------- */

/* ---------------------------------------------------------------------
   Log

   0.0 23-01-2005 Created
   1.0 23-01-2005 Initial version

   --------------------------------------------------------------------- */

#ifdef __cplusplus
#error This source file is not C++ but rather C. Please use a C-compiler
#endif

#include "ed/inc/fifos.h"
#include "ed/inc/sys.h"
#include "ed/inc/sysalloc.h"

/* macros ============================================================== */
/* constants =========================================================== */

#define S_ID "FIFOS"
#define S_VER "1.0"

/* types =============================================================== */
/* structures ========================================================== */

struct fifos
{
   char const **buf;
   size_t w;
   size_t r;
   size_t size;
   int full;
   int empty;
};

/* private variables =================================================== */
/* private functions =================================================== */
/* entry points ======================================================== */

/* ---------------------------------------------------------------------
   fifos_sid()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
char const *fifos_sid (void)
{
   return S_ID;
}

/* ---------------------------------------------------------------------
   fifos_sver()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
char const *fifos_sver (void)
{
   return S_VER;
}

/* ---------------------------------------------------------------------
   fifos_create()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
fifos_s *fifos_create (size_t size)
{
   fifos_s *this = malloc (sizeof *this);

   if (this != NULL)
   {
      CLR (this, fifos_s);
      this->empty = 1;
      this->size = size;
      this->buf = malloc (sizeof *this->buf * this->size);

      if (this->buf != NULL)
      {
         size_t i;

         for (i = 0; i < this->size; i++)
         {
            this->buf[i] = NULL;
         }
      }
      else
      {
         fifos_delete (this);
         this = NULL;
      }
   }
   return this;
}

/* ---------------------------------------------------------------------
   fifos_delete()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
void fifos_delete (fifos_s * this)
{
   if (this != NULL)
   {
      if (this->buf != NULL)
      {
         while (!this->empty)
         {
            free ((void *) fifos_get (this));
         }
         FREE (this->buf);
      }
      FREE (this);
   }
}

/* ---------------------------------------------------------------------
   fifos_full()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
int fifos_full (fifos_s * this)
{
   if (this != NULL)
   {
      return this->full;
   }
   else
   {
      return -1;
   }
}

/* ---------------------------------------------------------------------
   fifos_empty()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
int fifos_empty (fifos_s * this)
{
   if (this != NULL)
   {
      return this->empty;
   }
   else
   {
      return -1;
   }
}

/* ---------------------------------------------------------------------
   fifos_put()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
int fifos_put (fifos_s * this, char const *s)
{
   int err;

   if (this != NULL)
   {
      if (!this->full)
      {
         /* 's' must have been allocated */
         this->buf[this->w] = s;
         this->w = (this->w + 1) % this->size;
         this->full = this->w == this->r;
         this->empty = 0;
         err = 0;
      }
      else
      {
         err = 1;
      }
   }
   else
   {
      err = 1;
   }
   return err;
}

/* ---------------------------------------------------------------------
   fifos_get()
   ---------------------------------------------------------------------

   ---------------------------------------------------------------------
   I: 
   O: 
   --------------------------------------------------------------------- */
char const *fifos_get (fifos_s * this)
{
   char const *s = NULL;

   if (this != NULL)
   {
      if (!this->empty)
      {
         s = this->buf[this->r];
         this->buf[this->r] = NULL;
         this->r = (this->r + 1) % this->size;
         this->empty = this->w == this->r;
         this->full = 0;
      }
   }
   return s;
}

/* public variables ==================================================== */
